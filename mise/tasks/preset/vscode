#!/usr/bin/env bash
#MISE dir="{{cwd}}"

# Get mise shims path using mise activate bash --shims
# Extract the shims path from the export PATH command
MISE_SHIMS_PATH=$(mise activate bash --shims 2>/dev/null | grep -m1 '^export PATH=' | sed -E "s|^export PATH=\"([^\"]+):.*\"|\1|" || echo "")

# Fallback to default if command failed or path is empty
if [ -z "$MISE_SHIMS_PATH" ] || [ ! -d "$MISE_SHIMS_PATH" ]; then
  MISE_SHIMS_PATH="$HOME/.local/share/mise/shims"
fi

# Normalize path (expand ~, resolve symlinks)
MISE_SHIMS_PATH=$(eval echo "$MISE_SHIMS_PATH")
MISE_SHIMS_PATH=$(readlink -f "$MISE_SHIMS_PATH" 2>/dev/null || echo "$MISE_SHIMS_PATH")

# Detect platform
PLATFORM="linux"
if [[ "$OSTYPE" == "darwin"* ]]; then
  PLATFORM="osx"
elif [[ "$OSTYPE" == "msys" || "$OSTYPE" == "cygwin" || "$OSTYPE" == "win32" ]]; then
  PLATFORM="windows"
fi

# Create .vscode directory if it doesn't exist
mkdir -p .vscode

# Path to settings.json
SETTINGS_FILE=".vscode/settings.json"

# Create settings.json with empty object if it doesn't exist
if [ ! -f "$SETTINGS_FILE" ]; then
  echo "{}" > "$SETTINGS_FILE"
fi

# Determine the key based on platform
if [ "$PLATFORM" = "osx" ]; then
  ENV_KEY="terminal.integrated.env.osx"
elif [ "$PLATFORM" = "windows" ]; then
  ENV_KEY="terminal.integrated.env.windows"
else
  ENV_KEY="terminal.integrated.env.linux"
fi

# Get mise env variables (excluding PATH and Path)
MISE_ENV_JSON=$(mise env -J 2>/dev/null || echo "{}")

# Use jq if available, otherwise use a simpler approach
if command -v jq &>/dev/null; then
  # Use jq to update JSON
  # Read current settings
  SETTINGS=$(cat "$SETTINGS_FILE")

  # Update PATH to prepend mise shims and merge other env vars from mise env
  # Format: "PATH": "/path/to/shims:${env:PATH}"
  SETTINGS=$(echo "$SETTINGS" | jq --arg key "$ENV_KEY" --arg shims "$MISE_SHIMS_PATH" --argjson mise_env "$MISE_ENV_JSON" \
    '.[$key] = ((.[$key] // {}) |
      .PATH = ($shims + ":${env:PATH}") |
      . += ($mise_env | del(.PATH, .Path)))')

  # Write back
  echo "$SETTINGS" > "$SETTINGS_FILE"
else
  # Fallback: use Python if available (more reliable than sed)
  if command -v python3 &>/dev/null; then
    SETTINGS_FILE="$SETTINGS_FILE" ENV_KEY="$ENV_KEY" MISE_SHIMS_PATH="$MISE_SHIMS_PATH" MISE_ENV_JSON="$MISE_ENV_JSON" python3 << 'PYEOF'
import json
import os
import sys

settings_file = os.environ['SETTINGS_FILE']
env_key = os.environ['ENV_KEY']
shims_path = os.environ['MISE_SHIMS_PATH']
mise_env_json = os.environ.get('MISE_ENV_JSON', '{}')

# Read current settings
try:
    with open(settings_file, 'r') as f:
        settings = json.load(f)
except (FileNotFoundError, json.JSONDecodeError):
    settings = {}

# Parse mise env JSON
try:
    mise_env = json.loads(mise_env_json)
except (json.JSONDecodeError, TypeError):
    mise_env = {}

# Update PATH to prepend mise shims
if env_key not in settings:
    settings[env_key] = {}
# Use f-string with escaped braces: ${{ becomes ${, }} becomes }
settings[env_key]['PATH'] = f"{shims_path}:${{env:PATH}}"

# Merge other env vars from mise env (excluding PATH and Path)
for key, value in mise_env.items():
    if key != 'PATH' and key != 'Path':
        settings[env_key][key] = value

# Write back
with open(settings_file, 'w') as f:
    json.dump(settings, f, indent=2)
PYEOF
  else
    echo "Warning: jq or python3 not found. Please install one of them for proper JSON handling." >&2
    echo "You can manually add to $SETTINGS_FILE:" >&2
    echo "  \"$ENV_KEY\": {" >&2
    echo "    \"PATH\": \"$MISE_SHIMS_PATH:\${env:PATH}\"" >&2
    echo "  }" >&2
  fi
fi

echo "Updated $SETTINGS_FILE with mise shims path and environment variables for $PLATFORM: $MISE_SHIMS_PATH"
