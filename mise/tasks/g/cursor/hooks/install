#!/usr/bin/env bash
#MISE dir="{{cwd}}"
#MISE description="Install cursor hook for current project"
#USAGE arg "<name>" help="Hook name (e.g., pre-tool-call, post-tool-call)"
set -euo pipefail

HOOKS_FILE=".cursor/hooks.json"
HOOK_NAME="${usage_name}"
HOOK_CMD="mise run g:cursor:hooks:run ${HOOK_NAME}"

mkdir -p .cursor

if [[ ! -f "$HOOKS_FILE" ]]; then
    echo '{"version": 1, "hooks": {}}' >"$HOOKS_FILE"
fi

# Use jq to add/update the hook (each hook is an array of command objects)
jq --arg name "$HOOK_NAME" --arg cmd "$HOOK_CMD" \
    '.version = 1 | .hooks[$name] = [{"command": $cmd}]' "$HOOKS_FILE" >"$HOOKS_FILE.tmp" &&
    mv "$HOOKS_FILE.tmp" "$HOOKS_FILE"

echo "Installed hook '$HOOK_NAME' -> $HOOK_CMD"
