#!/usr/bin/env bash

# https://github.com/jamesottaway/tmux-up/blob/master/tmux-up

set -e
set -u
[ -n "${DEBUG:-}" ] && set -x || true

TMUX_UP=tmux-up
VERSION=0.5.1-fork
TMUX_COMM="${TMUX_COMM:-tmux}"
ARG1="${1:-}"

if [ "$ARG1" = '-h' ] || [ "$ARG1" = '--help' ]; then
  cat <<-USAGE
		Usage: $0 [FILE]
		Attach to a newly bootstrapped or existing tmux session.

		The FILE argument is used to bootstrap the new tmux session if it doesn't
		already exist. It must contain tmux-compatible commands, which will be
		passed to tmux. Defaults to: .tmux-up.conf

		  --help     display this help and exit
		  --version  output version information and exit
	USAGE
  exit 0
fi

if [ "$ARG1" = '-v' ] || [ "$ARG1" = '--version' ]; then
  cat <<-EOF
		$TMUX_UP $VERSION
		Copyright (C) 2015 James Ottaway
		License MIT: <http://opensource.org/licenses/MIT>.
		This is free software: you are free to change and redistribute it.
		There is NO WARRANTY, to the extent permitted by law.
	EOF
  exit 0
fi

FILE=
COMMANDS=
if [ -z "$ARG1" ]; then
  if [ "$PWD" = "$HOME" ]; then
    SESSION=chore
  elif [ ! -f '.tmux-up.conf' ]; then
    SESSION=$(basename "$PWD" | sed 's/[^a-zA-Z0-9\-]//g')
    COMMANDS='send "'"${EDITOR:-vim}"'" C-m
neww -n shell'
  else
    FILE=".tmux-up.conf"
  fi
else
  FILE='$ARG1'
fi

if [ -n "${FILE}" ]; then
  if ! [ -f "${FILE}" ]; then
    echo "File ${FILE} does not exist!" >&2
    exit 1
  fi

  BASE=$(basename "$PWD" | sed 's/[^a-zA-Z0-9\-]//g')
  NAME=$(basename "$FILE" .conf)

  if [ "$NAME" = '.tmux-up' ]; then
    SESSION="$BASE"
  else
    SESSION="$BASE/$NAME"
  fi
fi

if ! tmux has-session -t "=$SESSION" >/dev/null 2>&1; then
  TMUX='' tmux new-session -d -s "$SESSION"
  if [ -n "$COMMANDS" ]; then
    echo "Use default commands:"
    echo
    echo "$COMMANDS"
    echo "$COMMANDS" | xargs -L1 tmux
  elif [ -n "$FILE" ]; then
    tmux source "$FILE"
  fi
  tmux select-window -t 1
fi

if [ -z "${TMUX:-}" ]; then
  $TMUX_COMM attach -t "=$SESSION"
else
  tmux switch-client -t "=$SESSION"
fi
