#!/usr/bin/env bash

set -u
[ -n "${DEBUG:-}" ] && set -x || true

function vim_clipboard() {
  set -e

  local basename="$1"
  shift

  local arg="${1:-}"
  local dir="$(mktemp -d "$TMPDIR/edit-in-editor.XXXXX")"
  local file="$basename"

  case "x${arg}" in
    x.*) file="$file$arg";;
    *.*) file="$arg";;
    x) : ;;
    *) file="$file.$arg";;
  esac

  trap "rm -rf $dir" EXIT

  cd "$dir"
  if [ "$basename" = clipboard ]; then
    pbpaste > "$file"
    vim -n -b "$file" && pbcopy < "$file"
  else
    vim -n -b "$file"
  fi
}

if [ "${1:-}" = "--edit-clipboard" ]; then
  shift
  vim_clipboard clipboard "$@"
elif [ "${1:-}" = "--edit-scratch" ]; then
  shift
  vim_clipboard scratch "$@"
else
  vim "$@"
fi

kill -SIGUSR1 $PPID
