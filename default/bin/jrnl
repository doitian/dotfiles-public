#!/usr/bin/env bash

set -e
set -u
[ -n "${DEBUG:-}" ] && set -x || true

JOURNAL_DIR="$HOME/.journal"
if ! [ -e "$JOURNAL_DIR" ] && [ -d "$HOME/Dropbox/Brain/journal" ]; then
  ln -snf "$HOME/Dropbox/Brain/journal" "$HOME/.journal"
fi
JOURNAL_FILE="$JOURNAL_DIR/Journal $(date +'%Y-%m-%d').md"

ensure_journal_file() {
  if ! [ -e "$JOURNAL_DIR" ]; then
    mkdir -p "$JOURNAL_DIR"
  fi

  if ! [ -e "$JOURNAL_FILE" ]; then
    local date="${JOURNAL_FILE%.md}"
    date="${date##* }"

    echo "# Journal on $(date -j -f '%Y-%m-%d' $date +'%a, %b %d, %Y')

## Metadata

**Date**:: [[$date]]
**Kind**:: #journal

## Journal" >"$JOURNAL_FILE"
  fi
}

main() {
  ensure_journal_file

  sep_title="$*"
  if [ -n "$sep_title" ]; then
    sep_title=" $sep_title"
  fi

  (
    echo
    echo "### $(date +'%H:%M')${sep_title}"
    echo
  ) >>"$JOURNAL_FILE"
  cat >>"$JOURNAL_FILE"
  echo >>"$JOURNAL_FILE"

  echo "$JOURNAL_FILE"
}

main "$@"
