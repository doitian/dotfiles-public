#!/usr/bin/env bash

DICT_FILES=(
  "$HOME/.config/harper-ls/dictionary.txt"
  "$HOME/Dropbox/Apps/Harper/dictionary.txt"
)

# Create a temporary file securely
TMP_MERGED=$(mktemp)

# Define cleanup function to remove temp files
cleanup() {
  rm -f "$TMP_MERGED" "${TMP_MERGED}.sorted"
}

# Register cleanup function to run on script exit (normal or interrupted)
trap cleanup EXIT

# Clear temporary file
> "$TMP_MERGED"

# Append non-empty lines from existing files
for file in "${DICT_FILES[@]}"; do
  if [[ -f "$file" ]]; then
    grep -v '^[[:space:]]*$' "$file" >> "$TMP_MERGED"
  else
    echo "Warning: File '$file' does not exist. Ignoring."
  fi
done

# Handle Obsidian Harper settings (requires jq)
obsidian_harper_setting_path="$HOME/Dropbox/Brain/.obsidian/plugins/harper/data.json"
obsidian_loaded=false
if [[ -f "$obsidian_harper_setting_path" ]]; then
  if command -v jq >/dev/null 2>&1; then
    obsidian_loaded=true
    # Extract existing userDictionary from JSON
    jq -r '.userDictionary[]? // empty' "$obsidian_harper_setting_path" 2>/dev/null > "$TMP_MERGED"
  else
    echo "Warning: jq is not installed. Skipping Obsidian Harper settings update." >&2
  fi
fi

# Sort and unique (case-sensitive)
if (( ${#merged[@]} > 0 )); then
  mapfile -t merged < <(printf "%s\n" "${merged[@]}" | sort -u)
fi
# Sort, remove duplicates and empty lines, write to sorted temp file
sort -u "$TMP_MERGED" | grep -v '^[[:space:]]*$' > "${TMP_MERGED}.sorted"

# Overwrite existing files with merged content
for file in "${DICT_FILES[@]}"; do
  if [[ -f "$file" ]]; then
    cp "${TMP_MERGED}.sorted" "$file"
    echo "Synchronized $file"
  fi
done

# Update Obsidian Harper settings
if [[ "$obsidian_loaded" == true ]]; then
  # Create JSON array from merged words
  json_array=$(jq -R . "${TMP_MERGED}.sorted" | jq -s .)

  # Update the JSON file atomically
  temp_file="${obsidian_harper_setting_path}.tmp"
  jq --argjson arr "$json_array" '.userDictionary = $arr' "$obsidian_harper_setting_path" > "$temp_file" && mv "$temp_file" "$obsidian_harper_setting_path"
fi

echo "Synchronization complete."
