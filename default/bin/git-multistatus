#!/usr/bin/env bash

set -e
set -u
[ -n "${DEBUG:-}" ] && set -x || true

unset GIT_DIR
if [ -z "${GIT_MULTISTATUS_OUTPUT_FORMAT:-}" ]; then
  GIT_MULTISTATUS_OUTPUT_FORMAT=$'\001\e[30m\002'".- %s"
fi

function main() {
  for arg; do
    if ! [ -d "$arg" ]; then
      continue
    fi

    local directory="$(starship module -P "$arg" -p ~ directory)"
    local git_branch="$(starship module -p "$arg" git_branch)"
    local git_status="$(starship module -p "$arg" git_status)"

    printf "$GIT_MULTISTATUS_OUTPUT_FORMAT\n" "$directory$git_branch$git_status"
  done
}

if [ -t 1 ]; then
  export GIT_MULTISTATUS_OUTPUT_FORMAT="%s"
  PREVIEW_COMMAND="bash -c 'git -c color.ui=always -C {1} status --short --branch -u {1}'"
  RELOAD_COMMAND="git-multistatus$(printf ' %q' "$@")"
  KEYMAPS="ctrl-g:execute(bash -c 'cd {1} && lazygit')+reload($RELOAD_COMMAND)"
  main "$@" | fzf --ansi -d ' on ' --preview="$PREVIEW_COMMAND" --bind="$KEYMAPS"
else
  main "$@"
fi
