#!/usr/bin/env bash

# Usage:
# pandoc-pdf -i test.md -o test.pdf

set -e
set -u
[ -n "${DEBUG:-}" ] && set -x || true

detect_format() {
  case "$1" in
    markdown* | *.md)
      echo "markdown"
      ;;
    html* | *.html)
      echo "html"
      ;;
    pdf* | *.pdf | latex* | tex* | *.tex)
      echo "pdf"
      ;;
    word* | *.docx | *.doc)
      echo "doc"
      ;;
    *)
      echo "other"
      ;;
  esac
}

TO_FORMAT=other
DETECT_THIS=

for arg; do
  case "$arg" in
    -o | --output | -t | --to | -w | --write)
      DETECT_THIS=true
      ;;
    --output=* | --to=* | --write=*)
      DETECT_THIS=
      TO_FORMAT="$(detect_format "${arg#*=}")"
      ;;
    *)
      if [ -n "${DETECT_THIS}" ]; then
        DETECT_THIS=
        TO_FORMAT="$(detect_format "$arg")"
      fi
      ;;
  esac
done

echo "$TO_FORMAT"

# scrbook, scrreprt, scrartcl, scrlttr2 and typearea
DOCUMENTCLASS="${DOCUMENTCLASS:-scrreprt}"

PANDOC_OPTIONS=(
  --lua-filter "$HOME/.pandoc/filters/highlightings.lua"
  -H "$HOME/.pandoc/headers/latex.tex"
  --variable fontsize=12pt
  --variable linestretch=1.5
  --variable geometry=a4paper
  --variable documentclass="${DOCUMENTCLASS}"
)

pandoc "${PANDOC_OPTIONS[@]}" "$@" --pdf-engine=lualatex
