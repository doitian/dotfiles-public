#!/usr/bin/env zsh

set -e
[ -n "$DEBUG" ] && set -x

function main() {
  local attach
  local target
  local creation_opts
  while [ "$#" -gt 0 ]; do
    case "$1" in
      -S)
        shift
        target="$(env TMUX= tmux new-session -d -P)"
        ;;
      -s)
        shift
        target="$(env TMUX= tmux new-session -d -P -s "$1")"
        shift
        ;;
      -n)
        shift
        target="$(env TMUX= tmux new-window -d -P "${creation_opts[@]}")"
        ;;
      -N)
        shift
        target="$(env TMUX= tmux new-window -d -P -n "$1" "${creation_opts[@]}")"
        shift
        ;;
      -h|-v)
        target="$(env TMUX= tmux split-window -d $1 -P "${creation_opts[@]}")"
        shift
        ;;
      -a)
        shift
        attach=true
        ;;
      -t)
        shift
        target="$1"
        creation_opts=(-t "$1")
        shift
        ;;
      *)
        break
        ;;
    esac
  done

  local session="${target%%:*}"
  session="${session#=}"

  local has_session_result="$(tmux has-session -t "$target" 2>&1)"
  local has_session_status="$?"
  if ! [ "$has_session_status" = 0 ]; then
    if [ -z "$session" ]; then
      env TMUX= tmux new-session -d
    else
      echo "$has_session_result" >&2
      exit "$has_session_status"
    fi
  fi

  if [ -z "$1" ]; then
    if [ -z "$TMUX" ]; then
      tmux -u attach-session -t "$target"
    else
      tmux -u switch-client -t "$target"
    fi
  else
    if [ "$1" = "--" ]; then
      shift
      tmux send-keys -t "$target" "$*" C-m
    else
      tmux send-keys -t "$target" "$@" C-m
    fi

    if [ -n "$attach" ]; then
      if [ -z "$TMUX" ]; then
        tmux -u attach-session -t "$target"
      else
        tmux -u switch-client -t "$target"
      fi
    fi
  fi

  echo "$target"
}

main "$@"
