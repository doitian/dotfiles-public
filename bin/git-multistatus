#!/bin/bash

: ${GIT_MULTISTATUS_FILE=$HOME/.git_multistatus.conf}

main() {
  local dirty="\e[31mdirty"
  local clean="\e[32mclean"

  for repo; do
    if [ -n "$GIT_MULTISTATUS_EXPAND" ]; then
      repo="$(eval echo "$repo")"
    fi

    if [ -n "$(git -C "$repo" status --porcelain --ignore-submodules=dirty)" ]; then
      printf "%b\e[0m\t%s\n" "${dirty}" "$(realpath "$repo")"
    else
      printf "%b\e[0m\t%s\n" "${clean}" "$(realpath "$repo")"
    fi
  done
}

if [ "$1" = "-f" ]; then
  shift
  for file; do
    GIT_MULTISTATUS_EXPAND=1 xargs -L1 "$0" < "$file"
  done
  exit 0
fi

if [ "$#" -gt 0 ]; then
  main "$@"
elif [ -f "${GIT_MULTISTATUS_FILE}" ]; then
  GIT_MULTISTATUS_EXPAND=1 xargs -L1 "$0" < "$GIT_MULTISTATUS_FILE"
fi
